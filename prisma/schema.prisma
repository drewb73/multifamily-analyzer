// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MODEL - WITH TEAM WORKSPACE FEATURES
// ============================================================================
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId   String   @unique
  
  // Basic Info
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  company   String?
  
  // Subscription & Tiers
  subscriptionStatus String   @default("trial")  // "free", "trial", "premium", "enterprise"
  subscriptionTier   String?  // For special tiers: "discount_7day", "early_bird", etc.
  subscriptionSource String?  @default("manual") // "stripe", "manual", "discount_code"
  
  // Trial Management
  trialEndsAt        DateTime? // 72 hours from signup
  hasUsedTrial       Boolean  @default(false) // Prevent multiple trials
  
  // Premium Subscription
  subscriptionEndsAt DateTime? // For recurring subscriptions
  cancelledAt      DateTime? // When user clicked cancel (for churn tracking)
  stripeCustomerId   String?   // For Stripe integration
  stripeSubscriptionId String? // For Stripe integration
  
  // ðŸ†• TEAM WORKSPACE FIELDS - FOR WORKSPACE OWNERS
  // When a Premium user purchases seats, these fields track them
  purchasedSeats          Int      @default(0)  // Total seats they bought (e.g., 5)
  usedSeats               Int      @default(0)  // How many are filled (e.g., 3)
  availableSeats          Int      @default(0)  // Remaining seats (e.g., 2)
  seatSubscriptionItemId  String?  // Stripe subscription item ID for seat billing
  
  // ðŸ†• TEAM WORKSPACE FIELDS - FOR TEAM MEMBERS
  // When someone joins another person's workspace, these fields track it
  isTeamMember            Boolean  @default(false) // Are they a member of someone's team?
  teamWorkspaceOwnerId    String?  @db.ObjectId    // Who owns the workspace they're in?
  teamWorkspaceOwner      User?    @relation("TeamMembership", fields: [teamWorkspaceOwnerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  teamMembers             User[]   @relation("TeamMembership")
  
  // Admin Access
  isAdmin   Boolean  @default(false)
  
  // Account Status
  accountStatus  String   @default("active")  // "active", "inactive", "pending_deletion", "deleted"
  markedForDeletionAt DateTime?  // When user/admin initiated deletion
  deletedAt   DateTime?  // When account was actually deleted (60 days after marked)
  deletedBy   String?    // "user" or admin email who deleted it
  lastLoginAt DateTime?  // Track last login for inactivity
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // ðŸ†• TEAM WORKSPACE RELATIONS
  // These connect to the new models we're creating
  ownedTeamMembers      WorkspaceTeamMember[] @relation("WorkspaceOwner")     // Team members they own
  teamMemberships       WorkspaceTeamMember[] @relation("TeamMember")          // Teams they're part of
  sentInvitations       WorkspaceInvitation[] @relation("InvitationSender")    // Invitations they sent
  receivedInvitations   WorkspaceInvitation[] @relation("InvitationRecipient") // Invitations they received
  notifications         Notification[]                                          // Their notifications
  
  // Existing Relations
  properties         Property[]
  analyses           Analysis[]
  propertyAnalyses   PropertyAnalysis[]
  analysisGroups     AnalysisGroup[]
  deals              Deal[]
  dealNotes          DealNote[]
  dealChanges        DealChange[]

  @@map("users")
}

// ============================================================================
// ðŸ†• NEW MODEL: WORKSPACE INVITATION
// ============================================================================
// This tracks when someone invites another person to join their workspace
model WorkspaceInvitation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Who sent the invitation (the workspace owner)
  ownerId           String   @db.ObjectId
  owner             User     @relation("InvitationSender", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Who is being invited
  invitedEmail      String   // The email address invited
  invitedFirstName  String   // First name provided by owner
  invitedLastName   String   // Last name provided by owner
  invitedUserId     String?  @db.ObjectId  // If they're already a user, link to their User record
  invitedUser       User?    @relation("InvitationRecipient", fields: [invitedUserId], references: [id], onDelete: Cascade)
  
  // Invitation Token (for security)
  inviteToken       String   @unique  // Unique token sent in email link
  
  // Status Tracking
  status            String   // "pending", "pending_signup", "pending_premium_cancel", "accepted", "declined", "rescinded", "expired"
  invitationType    String   // "existing_user", "new_user", "premium_conflict"
  
  // Timestamps
  sentAt            DateTime @default(now())
  expiresAt         DateTime // Invitation expires after 7 days
  respondedAt       DateTime?
  
  // Prevent duplicate invitations to same email
  @@unique([ownerId, invitedEmail])
  @@index([invitedEmail])
  @@index([status])
}

// ============================================================================
// ðŸ†• NEW MODEL: WORKSPACE TEAM MEMBER
// ============================================================================
// This is the "active roster" - who is currently on someone's team
model WorkspaceTeamMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // The workspace owner
  ownerId     String   @db.ObjectId
  owner       User     @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // The team member
  memberId    String   @db.ObjectId
  member      User     @relation("TeamMember", fields: [memberId], references: [id], onDelete: Cascade)
  
  // Cached info (for display even if user deleted)
  memberEmail String
  memberName  String
  
  // Status
  status      String   @default("active") // "active" or "removed"
  role        String   @default("member") // For future: "member", "admin", "viewer"
  
  // Timestamps
  joinedAt    DateTime @default(now())
  removedAt   DateTime?
  
  // Prevent duplicate memberships
  @@unique([ownerId, memberId])
  @@index([ownerId])
  @@index([memberId])
  @@index([status])
}

// ============================================================================
// ðŸ†• NEW MODEL: NOTIFICATION
// ============================================================================
// In-app notifications for invitations, team events, etc.
model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Who this notification is for
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification Content
  type      String   // "team_invitation", "invitation_accepted", "invitation_declined", "member_removed", "member_joined", "premium_conflict"
  title     String
  message   String
  metadata  Json?    // Additional context (invitation ID, member name, etc.)
  
  // Status
  status    String   @default("unread") // "unread", "read", "archived"
  
  // Timestamps
  createdAt DateTime @default(now())
  readAt    DateTime?
  
  @@index([userId, status])
  @@index([createdAt])
}

// ============================================================================
// PROPERTY MODEL (LEGACY)
// ============================================================================
model Property {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name    String
  address String?
  city    String?
  state   String?
  zipCode String?
  
  // Property Details
  units          Int?
  purchasePrice  Float?
  
  // Income
  monthlyRent    Float?
  otherIncome    Float?
  
  // Expenses
  propertyTax    Float?
  insurance      Float?
  maintenance    Float?
  
  // Images (Cloudinary URLs)
  images      String[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  analyses Analysis[]

  @@map("properties")
}

// ============================================================================
// ANALYSIS MODEL (LEGACY) - UPDATED FOR ATTRIBUTION
// ============================================================================
model Analysis {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String   @db.ObjectId
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Analysis Info
  name String
  
  // Store all analysis data as JSON
  data Json
  
  // Key metrics (for quick filtering)
  capRate   Float?
  cashFlow  Float?
  roi       Float?
  
  // ðŸ†• ATTRIBUTION FIELDS - Track who created/edited this
  createdBy       String?  @db.ObjectId  // User ID who created this
  createdByName   String?                // Name at time of creation
  createdByRole   String?                // "owner" or "member"
  
  lastEditedBy     String?   @db.ObjectId  // User ID who last edited
  lastEditedByName String?                  // Name of last editor
  lastEditedAt     DateTime?                // When last edited
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analyses")
  @@index([createdBy])  // ðŸ†• Index for attribution queries

  // DealIQ Relations
  deals Deal[]
}

// ============================================================================
// PROPERTY ANALYSIS MODEL - UPDATED FOR ATTRIBUTION
// ============================================================================
model PropertyAnalysis {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String?  @db.ObjectId
  group     AnalysisGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Basic Info
  name      String
  notes     String?
  
  // Property Details (for filtering/searching)
  address   String
  city      String
  state     String
  zipCode   String
  
  purchasePrice    Float
  totalUnits       Int
  propertySize     Float
  isCashPurchase   Boolean
  downPayment      Float?
  loanTerm         Int?
  interestRate     Float?
  
  // Store complete analysis data as JSON
  data      Json
  results   Json
  
  // Searchable/Filterable Key Metrics (extracted for indexing)
  capRate              Float?
  cashFlow             Float?
  cashOnCashReturn     Float?
  grossRentMultiplier  Float?
  netOperatingIncome   Float?
  totalInvestment      Float?
  debtServiceCoverage  Float?
  
  // ðŸ†• ATTRIBUTION FIELDS
  createdBy       String?  @db.ObjectId
  createdByName   String?
  createdByRole   String?
  
  lastEditedBy     String?   @db.ObjectId
  lastEditedByName String?
  lastEditedAt     DateTime?
  
  // Status Flags
  isArchived  Boolean  @default(false)
  isFavorite  Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("property_analyses")
  @@index([userId, createdAt])
  @@index([userId, groupId])
  @@index([userId, isArchived])
  @@index([userId, isFavorite])
  @@index([zipCode])
  @@index([city])
  @@index([state])
  @@index([capRate])
  @@index([cashFlow])
  @@index([totalUnits])
  @@index([purchasePrice])
  @@index([createdBy])  // ðŸ†• Index for attribution
}

// ============================================================================
// ANALYSIS GROUP MODEL
// ============================================================================
model AnalysisGroup {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Group Info
  name        String
  description String?
  color       String?
  icon        String?
  
  // Sort order (for custom ordering)
  sortOrder   Int      @default(0)
  
  // Relations
  analyses    PropertyAnalysis[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("analysis_groups")
  @@index([userId, sortOrder])
}

// ============================================================================
// ADMIN MODELS
// ============================================================================
model SystemSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Application-Wide Toggles
  maintenanceMode      Boolean  @default(false)
  maintenanceMessage   String?
  dashboardEnabled     Boolean  @default(true)
  signUpEnabled        Boolean  @default(true)
  stripeEnabled        Boolean  @default(true)
  
  // Feature Toggles
  analysisEnabled      Boolean  @default(true)
  pdfExportEnabled     Boolean  @default(true)
  savedDraftsEnabled   Boolean  @default(true)
  accountDeletionEnabled Boolean @default(true)
  dealiqEnabled Boolean @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?
  
  @@map("system_settings")
}

model Banner {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Banner Content
  message   String
  type      String   @default("info")
  
  // Target Audience
  targetAudience String @default("all")
  
  // Display Control
  isActive  Boolean  @default(true)
  startDate DateTime @default(now())
  endDate   DateTime?
  durationDays Int?
  
  // Tracking
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("banners")
  @@index([isActive, targetAudience])
  @@index([startDate, endDate])
}

model PromoModal {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Modal Content
  title       String
  description String
  discountCode String?
  
  // Display Control
  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?
  durationDays Int?
  
  // Tracking
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("promo_modals")
}

model DiscountCode {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Code Details
  code      String   @unique
  duration  Int
  features  String[]
  
  // Usage Control
  maxUses   Int?
  usedCount Int      @default(0)
  isActive  Boolean  @default(true)
  
  // Validity Period
  validFrom DateTime @default(now())
  validUntil DateTime?
  
  // Relations
  redemptions CodeRedemption[]
  
  // Tracking
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("discount_codes")
}

model CodeRedemption {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relations
  codeId    String   @db.ObjectId
  code      DiscountCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  
  // User Info
  userId    String?
  userEmail String
  
  // Redemption Details
  redeemedAt DateTime @default(now())
  expiresAt  DateTime
  
  @@map("code_redemptions")
  @@index([codeId, userEmail])
}

model AdminLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Action Details
  adminEmail String
  action     String
  details    Json?
  
  // Timestamp
  createdAt DateTime @default(now())
  
  @@map("admin_logs")
  @@index([adminEmail, createdAt])
  @@index([createdAt])
}

// ============================================================================
// DEALIQ CRM SYSTEM - UPDATED FOR ATTRIBUTION
// ============================================================================
model Deal {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  dealId    String   @unique
  
  // Ownership
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Property Details (linked to analysis)
  analysisId String?  @db.ObjectId
  analysis   Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)
  
  // Address (editable)
  address    String
  city       String?
  state      String?
  zipCode    String?
  
  // Financial Details (editable)
  price           Float
  squareFeet      Float?
  units           Int?
  pricePerUnit    Float?
  pricePerSqft    Float?
  
  // Deal Status
  stage           String   @default("prospect")
  forecastStatus  String   @default("n/a")
  expectedCloseDate DateTime?
  
  // Commission Details (for agents)
  commissionPercent Float?  @default(0)
  commissionAmount  Float?  @default(0)
  
  // Investment Details (for investors)
  originalPurchasePrice Float?
  netValue          Float?
  
  // Loan Details
  financingType String?
  downPayment   Float?
  loanTerm      Int?
  loanRate      Float?
  
  // Lost Deal Tracking
  lostReason        String?
  lostReasonDetails String?
  lostAtStage       String?
  lostDate          DateTime?
  
  // On Hold Tracking
  holdReason        String?
  holdReasonDetails String?
  onHoldDate        DateTime?
  expectedResumeDate DateTime?
  
  // Pipeline Metrics
  daysInPipeline    Int?
  previousStage     String?
  
  // ðŸ†• ATTRIBUTION FIELDS
  createdBy       String?  @db.ObjectId
  createdByName   String?
  createdByRole   String?
  
  lastEditedBy     String?   @db.ObjectId
  lastEditedByName String?
  lastEditedAt     DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stageChangedAt DateTime @default(now())
  
  // Relations
  contacts  DealContact[]
  notes     DealNote[]
  changes   DealChange[]
  
  @@index([userId])
  @@index([stage])
  @@index([createdAt])
  @@index([createdBy])  // ðŸ†• Index for attribution
}

model DealContact {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  isPrimary Boolean  @default(false)
  name      String
  company   String?
  role      String?
  email     String?
  phone     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([dealId])
}

model DealNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([dealId])
  @@index([createdAt])
}

model DealChange {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fieldName     String
  previousValue String?
  newValue      String?
  
  createdAt DateTime @default(now())
  
  @@index([dealId])
  @@index([createdAt])
}