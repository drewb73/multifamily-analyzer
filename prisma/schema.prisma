// Minimal Prisma Schema for PropertyAnalyzer
// Start with this, then add features as needed

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MODELS (Start Here)
// ============================================

// User - Synced with Clerk
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId   String   @unique
  
  // Basic Info
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  company   String?
  
  // Admin Access
  isAdmin   Boolean  @default(false)
  
  // Subscription & Tiers
  subscriptionStatus String   @default("trial")  // "free", "trial", "premium", "enterprise"
  subscriptionTier   String?  // For special tiers: "discount_7day", "early_bird", etc.
  subscriptionSource String?  @default("manual") // "stripe", "manual", "discount_code"
  
  // Trial Management
  trialEndsAt        DateTime? // 72 hours from signup
  hasUsedTrial       Boolean  @default(false) // Prevent multiple trials
  
  // Premium Subscription
  subscriptionEndsAt DateTime? // For recurring subscriptions
  stripeCustomerId   String?   // For Stripe integration (future)
  stripeSubscriptionId String? // For Stripe integration (future)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  properties         Property[]
  analyses           Analysis[]
  propertyAnalyses   PropertyAnalysis[]
  analysisGroups     AnalysisGroup[]

  @@map("users")
}

// Property - Store property data (LEGACY - keeping for backward compatibility)
model Property {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name    String
  address String?
  city    String?
  state   String?
  zipCode String?
  
  // Property Details
  units          Int?
  purchasePrice  Float?
  
  // Income
  monthlyRent    Float?
  otherIncome    Float?
  
  // Expenses
  propertyTax    Float?
  insurance      Float?
  maintenance    Float?
  
  // Images (Cloudinary URLs)
  images      String[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  analyses Analysis[]

  @@map("properties")
}

// Analysis - Store property analyses (LEGACY - keeping for backward compatibility)
model Analysis {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String   @db.ObjectId
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Analysis Info
  name String
  
  // Store all analysis data as JSON
  data Json
  
  // Key metrics (for quick filtering)
  capRate   Float?
  cashFlow  Float?
  roi       Float?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analyses")
}

// ============================================
// NEW MODELS - Property Analysis System
// ============================================

// PropertyAnalysis - Full property analysis with grouping and filtering
model PropertyAnalysis {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String?  @db.ObjectId  // Optional: belongs to a group
  group     AnalysisGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Basic Info
  name      String
  notes     String?  // User notes about this analysis
  
  // Property Details (for filtering/searching)
  address   String
  city      String
  state     String
  zipCode   String
  
  purchasePrice    Float
  totalUnits       Int
  propertySize     Float
  isCashPurchase   Boolean
  downPayment      Float?
  loanTerm         Int?
  interestRate     Float?
  
  // Store complete analysis data as JSON
  data      Json  // Full AnalysisInputs (property, unitMix, expenses, income)
  results   Json  // Full AnalysisResults (keyMetrics, monthlyBreakdown, annualBreakdown)
  
  // Searchable/Filterable Key Metrics (extracted for indexing)
  capRate              Float?
  cashFlow             Float?
  cashOnCashReturn     Float?
  grossRentMultiplier  Float?
  netOperatingIncome   Float?
  totalInvestment      Float?
  debtServiceCoverage  Float?
  
  // Status Flags
  isArchived  Boolean  @default(false)
  isFavorite  Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("property_analyses")
  @@index([userId, createdAt])
  @@index([userId, groupId])
  @@index([userId, isArchived])
  @@index([userId, isFavorite])
  @@index([zipCode])
  @@index([city])
  @@index([state])
  @@index([capRate])
  @@index([cashFlow])
  @@index([totalUnits])
  @@index([purchasePrice])
}

// AnalysisGroup - Organize analyses into named collections
model AnalysisGroup {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Group Info
  name        String
  description String?
  color       String?  // Hex color for UI (e.g., "#3B82F6")
  icon        String?  // Icon name for UI (e.g., "Building", "TrendingUp")
  
  // Sort order (for custom ordering)
  sortOrder   Int      @default(0)
  
  // Relations
  analyses    PropertyAnalysis[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("analysis_groups")
  @@index([userId, sortOrder])
}

// ============================================
// ADMIN MODELS
// ============================================

// SystemSettings - Global app settings controlled by admin
model SystemSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Feature Toggles
  analysisEnabled    Boolean  @default(true)
  pdfExportEnabled   Boolean  @default(true)
  savedDraftsEnabled Boolean  @default(true)
  
  // Maintenance Mode
  maintenanceMode    Boolean  @default(false)
  maintenanceMessage String?
  
  // Timestamps
  updatedAt DateTime @updatedAt
  updatedBy String?  // Admin email who made the change
  
  @@map("system_settings")
}

// Banner - Informational banners displayed to users
model Banner {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Banner Content
  message     String
  type        String   @default("info")  // "info", "warning", "error", "success"
  
  // Display Settings
  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?
  
  // Timestamps
  createdAt   DateTime @default(now())
  createdBy   String   // Admin email who created it
  
  @@map("banners")
  @@index([isActive, startDate, endDate])
}

// DiscountCode - Promotional codes for special access
model DiscountCode {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Code Info
  code        String   @unique
  description String?
  
  // Access Settings
  durationDays Int     // How many days of access this code provides
  features     String[] // Which features to enable: ["analysis", "pdfExport", "savedDrafts"]
  
  // Usage Limits
  maxUses      Int?    // Null = unlimited
  usedCount    Int     @default(0)
  
  // Validity
  isActive     Boolean  @default(true)
  startDate    DateTime @default(now())
  endDate      DateTime?
  
  // Timestamps
  createdAt    DateTime @default(now())
  createdBy    String   // Admin email who created it
  
  // Relations
  redemptions  CodeRedemption[]
  
  @@map("discount_codes")
  @@index([isActive, startDate, endDate])
}

// CodeRedemption - Track code usage
model CodeRedemption {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  codeId    String   @db.ObjectId
  code      DiscountCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  
  userId    String
  userEmail String
  
  redeemedAt DateTime @default(now())
  expiresAt  DateTime
  
  @@map("code_redemptions")
  @@index([userId])
  @@index([codeId])
}

// AdminLog - Audit trail of admin actions
model AdminLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  adminEmail String
  action     String   // "user_updated", "feature_toggled", "banner_created", etc.
  details    Json     // Additional details about the action
  
  createdAt  DateTime @default(now())
  
  @@map("admin_logs")
  @@index([adminEmail, createdAt])
  @@index([createdAt])
}
