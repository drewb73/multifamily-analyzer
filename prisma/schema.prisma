// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER MODEL - UPDATED FOR TEAM WORKSPACES
// ============================================================================
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Clerk Authentication
  clerkId          String   @unique
  email            String   @unique
  firstName        String?
  lastName         String?
  profileImageUrl  String?
  
  // Subscription & Role
  role                    String   @default("user") // "user" or "admin"
  subscriptionStatus      String   @default("free") // "free", "trialing", "premium"
  subscriptionTier        String?  // "monthly" or "annual"
  stripeCustomerId        String?  @unique
  stripeSubscriptionId    String?  @unique
  currentPeriodEnd        DateTime?
  cancelAtPeriodEnd       Boolean  @default(false)
  
  // ðŸ†• TEAM WORKSPACE FIELDS - FOR WORKSPACE OWNERS
  // When a Premium user purchases seats, these fields track them
  purchasedSeats          Int      @default(0)  // Total seats they bought (e.g., 5)
  usedSeats               Int      @default(0)  // How many are filled (e.g., 3)
  availableSeats          Int      @default(0)  // Remaining seats (e.g., 2)
  seatSubscriptionItemId  String?  // Stripe subscription item ID for seat billing
  
  // ðŸ†• TEAM WORKSPACE FIELDS - FOR TEAM MEMBERS
  // When someone joins another person's workspace, these fields track it
  isTeamMember            Boolean  @default(false) // Are they a member of someone's team?
  teamWorkspaceOwnerId    String?  @db.ObjectId    // Who owns the workspace they're in?
  teamWorkspaceOwner      User?    @relation("TeamMembership", fields: [teamWorkspaceOwnerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  teamMembers             User[]   @relation("TeamMembership")
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLoginAt     DateTime?
  
  // Account Status
  isDeleted              Boolean   @default(false)
  deletionScheduledFor   DateTime?
  
  // ðŸ†• TEAM WORKSPACE RELATIONS
  // These connect to the new models we're creating
  ownedTeamMembers      WorkspaceTeamMember[] @relation("WorkspaceOwner")     // Team members they own
  teamMemberships       WorkspaceTeamMember[] @relation("TeamMember")          // Teams they're part of
  sentInvitations       WorkspaceInvitation[] @relation("InvitationSender")    // Invitations they sent
  receivedInvitations   WorkspaceInvitation[] @relation("InvitationRecipient") // Invitations they received
  notifications         Notification[]                                          // Their notifications
  
  // Existing Relations (unchanged)
  analyses              Analysis[]
  propertyAnalyses      PropertyAnalysis[]
  groups                Group[]
  deals                 Deal[]
  contacts              Contact[]
  notes                 Note[]
  activityLogs          ActivityLog[]
}

// ============================================================================
// ðŸ†• NEW MODEL: WORKSPACE INVITATION
// ============================================================================
// This tracks when someone invites another person to join their workspace
model WorkspaceInvitation {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Who sent the invitation (the workspace owner)
  ownerId           String   @db.ObjectId
  owner             User     @relation("InvitationSender", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Who is being invited
  invitedEmail      String   // The email address invited
  invitedFirstName  String   // First name provided by owner
  invitedLastName   String   // Last name provided by owner
  invitedUserId     String?  @db.ObjectId  // If they're already a user, link to their User record
  invitedUser       User?    @relation("InvitationRecipient", fields: [invitedUserId], references: [id], onDelete: Cascade)
  
  // Invitation Token (for security)
  inviteToken       String   @unique  // Unique token sent in email link
  
  // Status Tracking
  status            String   // "pending", "pending_signup", "pending_premium_cancel", "accepted", "declined", "rescinded", "expired"
  invitationType    String   // "existing_user", "new_user", "premium_conflict"
  
  // Timestamps
  sentAt            DateTime @default(now())
  expiresAt         DateTime // Invitation expires after 7 days
  respondedAt       DateTime?
  
  // Prevent duplicate invitations to same email
  @@unique([ownerId, invitedEmail])
  @@index([invitedEmail])
  @@index([status])
}

// ============================================================================
// ðŸ†• NEW MODEL: WORKSPACE TEAM MEMBER
// ============================================================================
// This is the "active roster" - who is currently on someone's team
model WorkspaceTeamMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // The workspace owner
  ownerId     String   @db.ObjectId
  owner       User     @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  // The team member
  memberId    String   @db.ObjectId
  member      User     @relation("TeamMember", fields: [memberId], references: [id], onDelete: Cascade)
  
  // Cached info (for display even if user deleted)
  memberEmail String
  memberName  String
  
  // Status
  status      String   @default("active") // "active" or "removed"
  role        String   @default("member") // For future: "member", "admin", "viewer"
  
  // Timestamps
  joinedAt    DateTime @default(now())
  removedAt   DateTime?
  
  // Prevent duplicate memberships
  @@unique([ownerId, memberId])
  @@index([ownerId])
  @@index([memberId])
  @@index([status])
}

// ============================================================================
// ðŸ†• NEW MODEL: NOTIFICATION
// ============================================================================
// In-app notifications for invitations, team events, etc.
model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Who this notification is for
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification Content
  type      String   // "team_invitation", "invitation_accepted", "invitation_declined", "member_removed", "member_joined", "premium_conflict"
  title     String
  message   String
  metadata  Json?    // Additional context (invitation ID, member name, etc.)
  
  // Status
  status    String   @default("unread") // "unread", "read", "archived"
  
  // Timestamps
  createdAt DateTime @default(now())
  readAt    DateTime?
  
  @@index([userId, status])
  @@index([createdAt])
}

// ============================================================================
// ANALYSIS MODEL - UPDATED FOR ATTRIBUTION
// ============================================================================
model Analysis {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Ownership
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ðŸ†• ATTRIBUTION FIELDS - Track who created/edited this
  createdBy       String?  @db.ObjectId  // User ID who created this
  createdByName   String?                // Name at time of creation
  createdByRole   String?                // "owner" or "member"
  
  lastEditedBy     String?   @db.ObjectId  // User ID who last edited
  lastEditedByName String?                  // Name of last editor
  lastEditedAt     DateTime?                // When last edited
  
  // Property Details
  name             String
  address          String?
  city             String?
  state            String?
  zipCode          String?
  propertyType     String?
  purchasePrice    Float
  afterRepairValue Float?
  downPayment      Float
  interestRate     Float
  loanTerm         Int
  closingCosts     Float?
  
  // Income
  monthlyRent      Float
  otherIncome      Float?
  
  // Expenses
  propertyTax      Float?
  insurance        Float?
  hoa              Float?
  maintenance      Float?
  utilities        Float?
  propertyManagement Float?
  vacancy          Float?
  otherExpenses    Float?
  
  // Calculated Metrics
  monthlyPayment   Float?
  totalMonthlyExpenses Float?
  netOperatingIncome Float?
  cashFlow         Float?
  capRate          Float?
  cashOnCashReturn Float?
  totalInvestment  Float?
  
  // Organization
  groupId          String?  @db.ObjectId
  group            Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  isFavorite       Boolean  @default(false)
  notes            String?
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([userId])
  @@index([groupId])
  @@index([createdAt])
  @@index([createdBy])  // ðŸ†• Index for attribution queries
}

// ============================================================================
// PROPERTY ANALYSIS MODEL - UPDATED FOR ATTRIBUTION
// ============================================================================
model PropertyAnalysis {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Ownership
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ðŸ†• ATTRIBUTION FIELDS
  createdBy       String?  @db.ObjectId
  createdByName   String?
  createdByRole   String?
  
  lastEditedBy     String?   @db.ObjectId
  lastEditedByName String?
  lastEditedAt     DateTime?
  
  // Property Info
  propertyName     String
  address          String?
  purchasePrice    Float
  
  // Unit Mix (JSON array)
  unitMix          Json
  
  // Financial Details
  downPaymentPercent Float
  interestRate     Float
  loanTermYears    Int
  closingCosts     Float?
  renovationCosts  Float?
  
  // Income
  otherMonthlyIncome Float?
  
  // Operating Expenses
  propertyTax      Float?
  insurance        Float?
  propertyManagement Float?
  maintenance      Float?
  utilities        Float?
  capex            Float?
  otherExpenses    Float?
  
  // Calculated Results (JSON)
  calculatedMetrics Json?
  
  // Organization
  groupId          String?  @db.ObjectId
  group            Group?   @relation(fields: [groupId], references: [id], onDelete: SetNull)
  isFavorite       Boolean  @default(false)
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([userId])
  @@index([groupId])
  @@index([createdBy])  // ðŸ†• Index for attribution
}

// ============================================================================
// DEAL MODEL - UPDATED FOR ATTRIBUTION
// ============================================================================
model Deal {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Ownership
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ðŸ†• ATTRIBUTION FIELDS
  createdBy       String?  @db.ObjectId
  createdByName   String?
  createdByRole   String?
  
  lastEditedBy     String?   @db.ObjectId
  lastEditedByName String?
  lastEditedAt     DateTime?
  
  // Deal Information
  propertyName     String
  propertyAddress  String?
  city             String?
  state            String?
  zipCode          String?
  
  // Financial
  purchasePrice    Float?
  estimatedValue   Float?
  commission       Float?
  
  // Deal Status
  stage            String   @default("lead") // lead, qualified, contract, closing, closed
  status           String   @default("active") // ðŸ†• "active" or "inactive"
  priority         String   @default("medium") // low, medium, high
  probability      Float?   // 0-100
  
  // Dates
  expectedCloseDate DateTime? // ðŸ†• Renamed from closeDate
  actualCloseDate   DateTime?
  
  // Relationships
  linkedAnalysisId String?  @db.ObjectId
  
  // Relations
  contacts         Contact[]
  notes            Note[]
  activityLogs     ActivityLog[]
  
  // Timestamps
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([userId])
  @@index([stage])
  @@index([status])  // ðŸ†• Index for status filtering
  @@index([createdBy])  // ðŸ†• Index for attribution
}

// ============================================================================
// REMAINING MODELS (Unchanged - keeping for completeness)
// ============================================================================

model Group {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name      String
  color     String?
  
  analyses           Analysis[]
  propertyAnalyses   PropertyAnalysis[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model Contact {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  name      String
  role      String?
  email     String?
  phone     String?
  company   String?
  isPrimary Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([dealId])
}

model Note {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  content   String
  isPinned  Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([dealId])
}

model ActivityLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  action    String   // "stage_changed", "note_added", "contact_added", etc.
  details   Json?    // Additional structured data
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([dealId])
  @@index([createdAt])
}

model SystemSettings {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  maintenanceMode Boolean  @default(false)
  bannerMessage   String?
  bannerType      String?  // "info", "warning", "error"
  updatedAt       DateTime @updatedAt
}

model Banner {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  message     String
  type        String   // "info", "warning", "error", "success"
  isActive    Boolean  @default(true)
  showOnPages String[] // ["dashboard", "all", etc.]
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
}

model PromoModal {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  message     String
  buttonText  String?
  buttonLink  String?
  isActive    Boolean  @default(false)
  imageUrl    String?
  showOnce    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
}