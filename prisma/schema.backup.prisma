// Minimal Prisma Schema for PropertyAnalyzer
// Start with this, then add features as needed

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MODELS (Start Here)
// ============================================

// User - Synced with Clerk
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId   String   @unique
  
  // Basic Info
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  company   String?
  
  // Subscription & Tiers
  subscriptionStatus String   @default("trial")  // "free", "trial", "premium", "enterprise"
  subscriptionTier   String?  // For special tiers: "discount_7day", "early_bird", etc.
  subscriptionSource String?  @default("manual") // "stripe", "manual", "discount_code"
  
  // Trial Management
  trialEndsAt        DateTime? // 72 hours from signup
  hasUsedTrial       Boolean  @default(false) // Prevent multiple trials
  
  // Premium Subscription
  subscriptionEndsAt DateTime? // For recurring subscriptions
  cancelledAt      DateTime? // When user clicked cancel (for churn tracking)
  stripeCustomerId   String?   // For Stripe integration (future)
  stripeSubscriptionId String? // For Stripe integration (future)
  
  // Admin Access
  isAdmin   Boolean  @default(false)
  
  // Account Status
  accountStatus  String   @default("active")  // "active", "inactive", "pending_deletion", "deleted"
  markedForDeletionAt DateTime?  // When user/admin initiated deletion
  deletedAt   DateTime?  // When account was actually deleted (60 days after marked)
  deletedBy   String?    // "user" or admin email who deleted it
  lastLoginAt DateTime?  // Track last login for inactivity
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  properties         Property[]
  analyses           Analysis[]
  propertyAnalyses   PropertyAnalysis[]
  analysisGroups     AnalysisGroup[]

  @@map("users")

  // DealIQ Relations
  deals         Deal[]
  dealNotes     DealNote[]
  dealChanges   DealChange[]
}

// Property - Store property data (LEGACY - keeping for backward compatibility)
model Property {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name    String
  address String?
  city    String?
  state   String?
  zipCode String?
  
  // Property Details
  units          Int?
  purchasePrice  Float?
  
  // Income
  monthlyRent    Float?
  otherIncome    Float?
  
  // Expenses
  propertyTax    Float?
  insurance      Float?
  maintenance    Float?
  
  // Images (Cloudinary URLs)
  images      String[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  analyses Analysis[]

  @@map("properties")
}

// Analysis - Store property analyses (LEGACY - keeping for backward compatibility)
model Analysis {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId String   @db.ObjectId
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Analysis Info
  name String
  
  // Store all analysis data as JSON
  data Json
  
  // Key metrics (for quick filtering)
  capRate   Float?
  cashFlow  Float?
  roi       Float?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analyses")

  // DealIQ Relations
  deals Deal[]
}

// ============================================
// NEW MODELS - Property Analysis System
// ============================================

// PropertyAnalysis - Full property analysis with grouping and filtering
model PropertyAnalysis {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String?  @db.ObjectId  // Optional: belongs to a group
  group     AnalysisGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  
  // Basic Info
  name      String
  notes     String?  // User notes about this analysis
  
  // Property Details (for filtering/searching)
  address   String
  city      String
  state     String
  zipCode   String
  
  purchasePrice    Float
  totalUnits       Int
  propertySize     Float
  isCashPurchase   Boolean
  downPayment      Float?
  loanTerm         Int?
  interestRate     Float?
  
  // Store complete analysis data as JSON
  data      Json  // Full AnalysisInputs (property, unitMix, expenses, income)
  results   Json  // Full AnalysisResults (keyMetrics, monthlyBreakdown, annualBreakdown)
  
  // Searchable/Filterable Key Metrics (extracted for indexing)
  capRate              Float?
  cashFlow             Float?
  cashOnCashReturn     Float?
  grossRentMultiplier  Float?
  netOperatingIncome   Float?
  totalInvestment      Float?
  debtServiceCoverage  Float?
  
  // Status Flags
  isArchived  Boolean  @default(false)
  isFavorite  Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("property_analyses")
  @@index([userId, createdAt])
  @@index([userId, groupId])
  @@index([userId, isArchived])
  @@index([userId, isFavorite])
  @@index([zipCode])
  @@index([city])
  @@index([state])
  @@index([capRate])
  @@index([cashFlow])
  @@index([totalUnits])
  @@index([purchasePrice])
}

// AnalysisGroup - Organize analyses into named collections
model AnalysisGroup {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Group Info
  name        String
  description String?
  color       String?  // Hex color for UI (e.g., "#3B82F6")
  icon        String?  // Icon name for UI (e.g., "Building", "TrendingUp")
  
  // Sort order (for custom ordering)
  sortOrder   Int      @default(0)
  
  // Relations
  analyses    PropertyAnalysis[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("analysis_groups")
  @@index([userId, sortOrder])
}

// ============================================
// ADMIN MODELS
// ============================================

// SystemSettings - Global feature toggles and settings
model SystemSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Application-Wide Toggles
  maintenanceMode      Boolean  @default(false)
  maintenanceMessage   String?
  dashboardEnabled     Boolean  @default(true)
  signUpEnabled        Boolean  @default(true)
  stripeEnabled        Boolean  @default(true)
  
  // Feature Toggles
  analysisEnabled      Boolean  @default(true)
  pdfExportEnabled     Boolean  @default(true)
  savedDraftsEnabled   Boolean  @default(true)
  accountDeletionEnabled Boolean @default(true)
  dealiqEnabled Boolean @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?  // Admin email who made the change
  
  @@map("system_settings")
}

// Banner - Dashboard banners for different user types
model Banner {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Banner Content
  message   String
  type      String   @default("info")  // "info", "warning", "error", "success"
  
  // Target Audience
  targetAudience String @default("all") // "all", "free_trial", "premium", "admin"
  
  // Display Control
  isActive  Boolean  @default(true)
  startDate DateTime @default(now())
  endDate   DateTime?
  durationDays Int?  // Duration in days from startDate
  
  // Tracking
  createdBy String   // Admin email
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("banners")
  @@index([isActive, targetAudience])
  @@index([startDate, endDate])
}

// PromoModal - Landing page promotional modal
model PromoModal {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Modal Content
  title       String
  description String
  discountCode String?
  
  // Display Control
  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?
  durationDays Int?  // Duration in days from startDate
  
  // Tracking
  createdBy   String   // Admin email
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("promo_modals")
}

// DiscountCode - Promotional codes for special access
model DiscountCode {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Code Details
  code      String   @unique
  duration  Int      // Days of access
  features  String[] // Feature access granted
  
  // Usage Control
  maxUses   Int?     // Null = unlimited
  usedCount Int      @default(0)
  isActive  Boolean  @default(true)
  
  // Validity Period
  validFrom DateTime @default(now())
  validUntil DateTime?
  
  // Relations
  redemptions CodeRedemption[]
  
  // Tracking
  createdBy String   // Admin email
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("discount_codes")
}

// CodeRedemption - Track who used which codes
model CodeRedemption {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Relations
  codeId    String   @db.ObjectId
  code      DiscountCode @relation(fields: [codeId], references: [id], onDelete: Cascade)
  
  // User Info (not foreign key to allow deletions)
  userId    String?  // User ID if they were logged in
  userEmail String   // Email for tracking
  
  // Redemption Details
  redeemedAt DateTime @default(now())
  expiresAt  DateTime
  
  @@map("code_redemptions")
  @@index([codeId, userEmail])
}

// AdminLog - Audit trail of admin actions
model AdminLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // Action Details
  adminEmail String
  action     String   // "user_deleted", "feature_toggled", etc.
  details    Json?    // Additional context
  
  // Timestamp
  createdAt DateTime @default(now())
  
  @@map("admin_logs")
  @@index([adminEmail, createdAt])
  @@index([createdAt])
}

// ============================================
// DEALIQ CRM SYSTEM
// ============================================

model Deal {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  dealId    String   @unique // 7-digit random number (e.g., "1234567")
  
  // Ownership
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Property Details (linked to analysis)
  analysisId String?  @db.ObjectId
  analysis   Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)
  
  // Address (editable)
  address    String
  city       String?
  state      String?
  zipCode    String?
  
  // Financial Details (editable)
  price           Float
  squareFeet      Float?
  units           Int?
  pricePerUnit    Float?  // Auto-calculated: price / units
  pricePerSqft    Float?  // Auto-calculated: price / squareFeet
  
  // Deal Status
  stage           String   @default("prospect") // See DEAL_STAGES constant
  forecastStatus  String   @default("n/a") // "n/a", "commit", "upside", "most_likely"
  expectedCloseDate DateTime?
  
  // Commission Details (for agents)
  commissionPercent Float?  @default(0)
  commissionAmount  Float?  @default(0) // Auto-calculated: price * commissionPercent
  
  // Investment Details (for investors)
  originalPurchasePrice Float? // Optional: for investors tracking equity
  netValue          Float?  // Auto-calculated: price - commission - originalPurchase
  
  // Loan Details
  financingType String? // "financed", "cash"
  downPayment   Float?  // Down payment amount
  loanTerm      Int?    // Years (e.g., 30)
  loanRate      Float?  // Interest rate percentage (e.g., 6.5)
  
  // Lost Deal Tracking (when stage = "closed_lost")
  lostReason        String?   // ID from LOST_REASONS
  lostReasonDetails String?   // Additional notes
  lostAtStage       String?   // Stage where deal was lost
  lostDate          DateTime?
  
  // On Hold Tracking (when stage = "on_hold")
  holdReason        String?   // ID from HOLD_REASONS
  holdReasonDetails String?
  onHoldDate        DateTime?
  expectedResumeDate DateTime?
  
  // Pipeline Metrics
  daysInPipeline    Int?      // Auto-calculated
  previousStage     String?   // Track last stage before current
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stageChangedAt DateTime @default(now())
  
  // Relations
  contacts  DealContact[]
  notes     DealNote[]
  changes   DealChange[]
  
  @@index([userId])
  @@index([stage])
  @@index([createdAt])
}

model DealContact {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  isPrimary Boolean  @default(false)
  name      String
  company   String?
  role      String?  // "Seller", "Agent", "Lender", "Attorney", etc.
  email     String?
  phone     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([dealId])
}

model DealNote {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([dealId])
  @@index([createdAt])
}

model DealChange {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  
  dealId    String   @db.ObjectId
  deal      Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fieldName     String  // "stage", "price", "expectedCloseDate", etc.
  previousValue String?
  newValue      String?
  
  createdAt DateTime @default(now())
  
  @@index([dealId])
  @@index([createdAt])
}